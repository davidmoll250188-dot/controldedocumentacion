<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Seguimiento Docente</title>
    
    <!-- 1. LIBRERÍAS (CDNs Estables) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Gráficos (Recharts) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.min.js"></script>

    <!-- FIREBASE (Versión Compat - La más estable) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; color: #1e293b; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .card { break-inside: avoid; border: 1px solid #ddd; box-shadow: none; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBZBFUrU6rAAcpDXKetsH3eT2XyZQ2e3Rg",
            authDomain: "control-docentes.firebaseapp.com",
            projectId: "control-docentes",
            storageBucket: "control-docentes.firebasestorage.app",
            messagingSenderId: "759330033292",
            appId: "1:759330033292:web:ed0bcf6487779b184e75a9"
        };

        // Inicialización segura
        try {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
        } catch (e) {
            console.error("Error Firebase Init:", e);
        }

        // --- 2. ICONOS SVG (INCRUSTADOS) ---
        const SvgIcon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            Users: () => <SvgIcon><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></SvgIcon>,
            Chart: () => <SvgIcon><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></SvgIcon>,
            List: () => <SvgIcon><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></SvgIcon>,
            Check: () => <SvgIcon><polyline points="20 6 9 17 4 12"/></SvgIcon>,
            CheckCircle: () => <SvgIcon><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></SvgIcon>,
            XCircle: () => <SvgIcon><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></SvgIcon>,
            Plus: () => <SvgIcon><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></SvgIcon>,
            Trash: () => <SvgIcon><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></SvgIcon>,
            Refresh: () => <SvgIcon><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></SvgIcon>,
            Print: () => <SvgIcon><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></SvgIcon>,
            FileText: () => <SvgIcon><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></SvgIcon>,
            Alert: () => <SvgIcon><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></SvgIcon>,
            Filter: () => <SvgIcon><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></SvgIcon>,
            Menu: () => <SvgIcon><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></SvgIcon>,
            X: () => <SvgIcon><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></SvgIcon>,
            Wifi: () => <SvgIcon><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></SvgIcon>,
            ArrowRight: () => <SvgIcon><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></SvgIcon>,
            FileSpreadsheet: () => <SvgIcon><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></SvgIcon>
        };

        // --- 3. COMPONENTES UI ---
        const Card = ({ children, className }) => <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>;
        const Badge = ({ children }) => <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2.5 py-0.5 rounded border border-blue-200">{children}</span>;

        // --- 4. GRÁFICOS (Componente Seguro) ---
        // Este componente solo intentará renderizar si Recharts existe
        const SafePieChart = ({ percent, color }) => {
            const [isLoaded, setIsLoaded] = React.useState(false);
            
            React.useEffect(() => {
                if (window.Recharts && window.Recharts.PieChart) {
                    setIsLoaded(true);
                }
            }, []);

            if (!isLoaded) {
                // Fallback visual: Barra de progreso si falla el gráfico
                return (
                    <div className="w-full h-40 flex flex-col justify-center items-center">
                        <div className="w-full bg-slate-100 rounded-full h-8 overflow-hidden border border-slate-200 relative">
                            <div className="h-8 rounded-full flex items-center justify-center text-xs font-bold text-white transition-all duration-1000" 
                                 style={{ width: `${Math.max(percent, 5)}%`, backgroundColor: color }}>
                            </div>
                        </div>
                         <span className="text-3xl font-black text-slate-700 mt-4">{percent}%</span>
                    </div>
                );
            }

            const { PieChart, Pie, Cell, ResponsiveContainer } = window.Recharts;
            const data = [{ name: 'Completado', value: percent }, { name: 'Pendiente', value: 100 - percent }];

            return (
                <div className="w-full h-40 relative z-10">
                    <ResponsiveContainer width="100%" height="100%">
                        <PieChart>
                            <Pie data={data} cx="50%" cy="50%" innerRadius={50} outerRadius={70} startAngle={90} endAngle={-270} dataKey="value">
                                <Cell fill={color} />
                                <Cell fill="#f1f5f9" />
                            </Pie>
                        </PieChart>
                    </ResponsiveContainer>
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span className="text-3xl font-black text-slate-700">{percent}%</span>
                    </div>
                </div>
            );
        };

        const ChartCard = ({ title, percent, color }) => {
            return (
                <Card className="p-6 flex flex-col items-center justify-center relative overflow-hidden h-64">
                    <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2 z-10">{title}</h3>
                    <SafePieChart percent={percent} color={color} />
                </Card>
            );
        };

        const StatusGrid = ({ items, docente, requiredItems }) => {
            const relevant = items.filter(i => requiredItems.includes(i));
            if (!relevant.length) return <div className="text-slate-400 italic text-sm p-4">No hay documentos requeridos para esta vista.</div>;

            return (
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                    {relevant.map((doc, i) => {
                        const data = docente.documentos?.[doc] || {};
                        const isDone = data.entregado;
                        const percent = data.porcentaje !== undefined ? data.porcentaje : (isDone ? 100 : 0);
                        const hasObs = data.obs && data.obs.length > 0;

                        return (
                            <div key={i} className={`relative p-3 rounded-lg border flex flex-col items-center text-center min-h-[120px] transition-all ${isDone ? (percent < 100 ? 'bg-amber-50 border-amber-300' : 'bg-emerald-50 border-emerald-300') : 'bg-white border-slate-200 opacity-75'}`}>
                                {hasObs && <div className="absolute top-1 right-1 w-4 h-4 text-amber-500"><Icons.Alert/></div>}
                                <div className="mb-2 w-6 h-6">
                                    {isDone 
                                        ? <div className={`p-1 rounded-full ${percent < 100 ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600'}`}><Icons.CheckCircle/></div>
                                        : <div className="p-1 rounded-full bg-slate-100 text-slate-400"><Icons.XCircle/></div>
                                    }
                                </div>
                                <span className="text-xs font-semibold leading-tight text-slate-700 line-clamp-2">{doc}</span>
                                {isDone && <span className="mt-1 text-[10px] font-bold bg-white px-2 rounded border">{percent}%</span>}
                            </div>
                        )
                    })}
                </div>
            );
        };

        const ChecklistGroup = ({ title, items, docente, requiredItems, onToggle, onObs, onPercent }) => {
            const relevant = items.filter(i => requiredItems.includes(i));
            if (!relevant.length) return null;

            return (
                <div className="mb-8">
                    <h4 className="text-sm font-bold text-slate-600 uppercase tracking-widest mb-3 flex items-center border-b pb-2 border-slate-200">
                        <span className="w-4 h-4 mr-2 text-blue-500 inline-block"><Icons.FileText/></span> {title}
                    </h4>
                    <div className="space-y-3">
                        {relevant.map((doc, idx) => {
                            const data = docente.documentos?.[doc] || {};
                            const isDone = data.entregado;
                            const percent = data.porcentaje !== undefined ? data.porcentaje : (isDone ? 100 : 0);
                            const hasObs = data.obs && data.obs.length > 0;

                            return (
                                <div key={idx} className={`rounded-lg border-2 transition-all p-3 ${isDone ? 'bg-blue-50/50 border-blue-200' : 'bg-white border-slate-200 hover:border-blue-300'}`}>
                                    <div className="flex gap-3">
                                        <div onClick={() => onToggle(docente.id, doc)} className={`mt-0.5 flex-shrink-0 w-6 h-6 rounded flex items-center justify-center border cursor-pointer ${isDone ? 'bg-blue-500 border-blue-500 text-white' : 'bg-white border-slate-300'}`}>
                                            {isDone && <div className="w-4 h-4"><Icons.Check/></div>}
                                        </div>
                                        <div className="flex-1">
                                            <div onClick={() => onToggle(docente.id, doc)} className="font-medium text-sm text-slate-800 cursor-pointer">{doc}</div>
                                            {(isDone && hasObs) && (
                                                <div className="mt-2 flex items-center gap-2 bg-white/60 p-1.5 rounded">
                                                    <span className="text-[10px] font-bold text-slate-500 uppercase">CALIF:</span>
                                                    <input type="range" className="w-24 h-1 bg-slate-300 rounded-lg appearance-none cursor-pointer" min="0" max="100" value={percent} onChange={(e) => onPercent(docente.id, doc, parseInt(e.target.value))} />
                                                    <span className={`text-xs font-bold ${percent<100 ? 'text-amber-600':'text-emerald-600'}`}>{percent}%</span>
                                                </div>
                                            )}
                                        </div>
                                        <div className="w-1/3">
                                            <textarea rows="1" placeholder="Obs..." className={`w-full text-xs p-2 rounded border focus:ring-1 focus:ring-blue-500 outline-none resize-y ${hasObs ? 'bg-amber-50 border-amber-300' : 'bg-slate-50 border-slate-200'}`} value={data.obs || ""} onChange={(e) => onObs(docente.id, doc, e.target.value)}></textarea>
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            )
        };

        // --- 5. LOGICA PRINCIPAL (APP) ---
        const App = () => {
            const [user, setUser] = React.useState(null);
            const [docentes, setDocentes] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState("");
            const [isOnline, setIsOnline] = React.useState(navigator.onLine);
            
            // Navegación & Filtros
            const [view, setView] = React.useState('dashboard'); 
            const [selectedTeacherId, setSelectedTeacherId] = React.useState("");
            const [teacherViewMode, setTeacherViewMode] = React.useState('stats'); 
            const [roleSelectionNeeded, setRoleSelectionNeeded] = React.useState(false);
            const [currentRoleFilter, setCurrentRoleFilter] = React.useState("ALL");
            const [mobileMenu, setMobileMenu] = React.useState(false);

            // Formulario
            const [newTeacher, setNewTeacher] = React.useState({ nombre: "", roles: [], details: { grade: "", area: "", regency: "" } });
            const [showImport, setShowImport] = React.useState(false);
            const [importText, setImportText] = React.useState("");

            // --- CONSTANTES ---
            const ROLES = { TUTOR: "Docente Tutor", AREA: "Docente Área a Cargo", REGENCIA: "Regencia" };
            const GRADES = ["Inicial 3", "Inicial 4", "Inicial 5", "Primero P", "Segundo P", "Tercero P", "Cuarto P", "Quinto P", "Sexto P", "Primero S", "Segundo S", "Tercero S", "Cuarto S", "Quinto S"];
            const AREAS = ["Comunicación", "Matemática", "Religión", "Ciencias Sociales", "Personal Social", "Inglés", "EPT", "Ciencia y Tecnología", "Arte", "DPCYC", "Ed. Física"];
            
            const DOCS = [
                "Carátula", "Registro de estudiantes", "Asistencia", "Llenado de: (competencias, capacidades, desempeños y criterios)", 
                "Llenado de conclusiones descriptivas", "Llenado de comportamiento", "Llenado de apreciación del tutor",
                "Formato Oficial de Notas (SIAGIE)", "Conclusiones Descriptivas (SIAGIE)", "Comentario General", "Determinación de Primeros Puestos", 
                "Registro de HSE y FR", "Informe de HSE y FR", "Informe de Nivel de Logro de Competencia", "Inventario", 
                "Informe de Estudiantes con R.R.", "Informe de Estudiantes con P.G.", "Informe de Tutoría"
            ];
            
            const RULES = {
                [ROLES.TUTOR]: DOCS,
                [ROLES.AREA]: ["Llenado de: (competencias, capacidades, desempeños y criterios)", "Llenado de conclusiones descriptivas", "Formato Oficial de Notas (SIAGIE)", "Conclusiones Descriptivas (SIAGIE)"],
                [ROLES.REGENCIA]: ["Llenado de comportamiento", "Inventario"]
            };

            // --- EFECTOS ---
            React.useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                // Instancias de Firebase
                const db = (typeof firebase !== 'undefined' && firebase.firestore) ? firebase.firestore() : null;
                const auth = (typeof firebase !== 'undefined' && firebase.auth) ? firebase.auth() : null;

                if (!auth || !db) {
                    setError("Firebase no inicializado correctamente.");
                    setLoading(false);
                    return;
                }

                // Auth Anónima
                auth.signInAnonymously().catch(e => {
                    console.error("Auth:", e);
                    setError("Error de autenticación: " + e.message);
                    setLoading(false);
                });
                
                const unsubscribeAuth = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if(u) {
                        const unsubscribeDB = db.collection('docentes').onSnapshot(snap => {
                            const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                            setDocentes(data.sort((a,b) => a.nombre.localeCompare(b.nombre)));
                            setLoading(false);
                            setError("");
                        }, err => {
                            console.error("DB:", err);
                            if(err.code === 'permission-denied') setError("Permiso denegado. Revisa las reglas de Firestore.");
                            else setError("Error de conexión a datos: " + err.message);
                            setLoading(false);
                        });
                        return () => unsubscribeDB();
                    }
                });

                const timer = setTimeout(() => {
                    if (loading) setLoading(false);
                }, 8000);

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                    if(unsubscribeAuth) unsubscribeAuth();
                    clearTimeout(timer);
                };
            }, []);

            // --- HELPERS ---
            const getRoles = (d) => d.roles && d.roles.length ? d.roles : (d.rol ? [d.rol] : []);
            
            const getRequiredDocs = (d, filterRole = "ALL") => {
                if(!d) return [];
                const roles = getRoles(d);
                let needed = new Set();
                roles.forEach(r => {
                    if(filterRole === "ALL" || filterRole === r) {
                        (RULES[r] || []).forEach(doc => needed.add(doc));
                    }
                });
                return Array.from(needed);
            };

            const calcProgress = (d, filterRole) => {
                const req = getRequiredDocs(d, filterRole);
                if(!req.length) return 0;
                let sum = 0;
                req.forEach(doc => {
                    const info = d.documentos?.[doc];
                    if(info?.entregado) sum += (info.porcentaje ?? 100);
                });
                return Math.round(sum / req.length);
            };

            // --- ACCIONES DB ---
            const dbRef = () => firebase.firestore().collection('docentes');

            const selectTeacher = (id) => {
                setSelectedTeacherId(id);
                setTeacherViewMode('stats');
                const doc = docentes.find(d => d.id === id);
                if(doc && getRoles(doc).length > 1) {
                    setRoleSelectionNeeded(true);
                    setCurrentRoleFilter("ALL");
                } else {
                    setRoleSelectionNeeded(false);
                    setCurrentRoleFilter("ALL");
                }
            };

            const toggleDoc = (id, docName) => {
                const d = docentes.find(x => x.id === id);
                const curr = d.documentos?.[docName] || {};
                const nextState = !curr.entregado;
                const newDocs = { 
                    ...d.documentos, 
                    [docName]: { ...curr, entregado: nextState, porcentaje: nextState ? 100 : 0 } 
                };
                dbRef().doc(id).update({ documentos: newDocs });
            };

            const updateObs = (id, docName, val) => {
                const d = docentes.find(x => x.id === id);
                const curr = d.documentos?.[docName] || {};
                const newDocs = { ...d.documentos, [docName]: { ...curr, obs: val } };
                dbRef().doc(id).update({ documentos: newDocs });
            };

            const updatePercent = (id, docName, val) => {
                const d = docentes.find(x => x.id === id);
                const curr = d.documentos?.[docName] || {};
                const newDocs = { ...d.documentos, [docName]: { ...curr, porcentaje: val } };
                dbRef().doc(id).update({ documentos: newDocs });
            };

            const addTeacher = (e) => {
                e.preventDefault();
                if(!newTeacher.nombre.trim()) return alert("Nombre requerido");
                if(!newTeacher.roles.length) return alert("Selecciona al menos un rol");
                
                let parts = [];
                if(newTeacher.roles.includes(ROLES.TUTOR) && newTeacher.details.grade) parts.push(`Tutor: ${newTeacher.details.grade}`);
                if(newTeacher.roles.includes(ROLES.AREA) && newTeacher.details.area) parts.push(`Área: ${newTeacher.details.area}`);
                if(newTeacher.roles.includes(ROLES.REGENCIA) && newTeacher.details.regency) parts.push(newTeacher.details.regency);
                
                dbRef().add({
                    nombre: newTeacher.nombre,
                    roles: newTeacher.roles,
                    rol: newTeacher.roles[0],
                    detalle: parts.join(" | "),
                    documentos: {},
                    createdAt: new Date().toISOString()
                });
                
                setNewTeacher({ nombre: "", roles: [], details: { grade: "", area: "", regency: "" } });
                alert("Guardado");
            };

            const toggleNewRole = (r) => {
                const current = newTeacher.roles;
                const next = current.includes(r) ? current.filter(x => x !== r) : [...current, r];
                setNewTeacher({...newTeacher, roles: next});
            };

            const deleteTeacher = (id) => {
                if(confirm("¿Eliminar registro permanentemente?")) {
                    dbRef().doc(id).delete();
                    if(selectedTeacherId === id) setSelectedTeacherId("");
                }
            };
            
            const handleImport = () => {
                if (!importText.trim()) return;
                const lines = importText.split('\n');
                let count = 0;
                lines.forEach(line => {
                    const parts = line.split(/\t|,/);
                    if(parts.length >= 1 && parts[0].trim()) {
                         let roles = [ROLES.TUTOR];
                         const rStr = parts[1] ? parts[1].toLowerCase() : "";
                         if(rStr.includes('área') || rStr.includes('area')) roles = [ROLES.AREA];
                         if(rStr.includes('regencia')) roles = [ROLES.REGENCIA];
                         
                         dbRef().add({
                             nombre: parts[0].trim(),
                             roles: roles,
                             rol: roles[0],
                             detalle: parts[2] ? parts[2].trim() : "",
                             documentos: {},
                             createdAt: new Date().toISOString()
                         });
                         count++;
                    }
                });
                setImportText("");
                setShowImport(false);
                alert(`Importados ${count} registros.`);
            };

            // --- RENDER ---
            if(loading) return <div className="h-screen flex items-center justify-center flex-col text-slate-500"><div className="animate-spin w-10 h-10 mb-4 text-blue-600 border-4 border-blue-600 border-t-transparent rounded-full"></div><p>Cargando Sistema...</p></div>;
            
            const activeDocente = docentes.find(d => d.id === selectedTeacherId);
            const activeRoles = activeDocente ? getRoles(activeDocente) : [];
            const progress = activeDocente ? calcProgress(activeDocente, currentRoleFilter) : 0;

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    {/* NAV */}
                    <nav className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="w-6 h-6 text-blue-400"><Icons.FileText/></div>
                                <span className="font-bold text-lg">DOCENTE<span className="text-blue-400">CHECK</span></span>
                                <div className={`flex items-center ml-4 text-[10px] px-2 py-0.5 rounded-full ${isOnline ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`}>
                                    <span className="w-3 h-3 mr-1 inline-block">{isOnline ? <Icons.Wifi/> : <Icons.WifiOff/>}</span> 
                                    {isOnline ? 'EN LÍNEA' : 'OFFLINE'}
                                </div>
                            </div>
                            <div className="hidden md:flex gap-4">
                                <button onClick={() => setView('dashboard')} className={`px-3 py-1 rounded font-bold transition ${view==='dashboard' ? 'bg-blue-600' : 'hover:bg-slate-800'}`}>Dashboard</button>
                                <button onClick={() => setView('list')} className={`px-3 py-1 rounded font-bold transition ${view==='list' ? 'bg-blue-600' : 'hover:bg-slate-800'}`}>Lista</button>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => window.location.reload()} className="p-2 bg-slate-800 rounded hover:bg-slate-700"><div className="w-4 h-4"><Icons.Refresh/></div></button>
                                <button onClick={() => window.print()} className="p-2 bg-red-600 rounded hover:bg-red-500 text-xs font-bold flex items-center"><div className="w-4 h-4 mr-1"><Icons.Print/></div> PDF</button>
                                <button className="md:hidden" onClick={() => setMobileMenu(!mobileMenu)}><div className="w-6 h-6"><Icons.Menu/></div></button>
                            </div>
                        </div>
                        {mobileMenu && (
                            <div className="md:hidden mt-2 pt-2 border-t border-slate-700">
                                <button onClick={() => {setView('dashboard'); setMobileMenu(false)}} className="block w-full text-left py-2 hover:bg-slate-800">Dashboard</button>
                                <button onClick={() => {setView('list'); setMobileMenu(false)}} className="block w-full text-left py-2 hover:bg-slate-800">Lista</button>
                            </div>
                        )}
                    </nav>

                    {/* MAIN */}
                    <main className="flex-1 overflow-auto p-4 md:p-8">
                        <div className="max-w-7xl mx-auto pb-20">
                            {error && <div className="bg-red-100 text-red-700 p-4 rounded mb-4 flex items-center"><div className="w-5 h-5 mr-2"><Icons.Alert/></div>{error}</div>}

                            {/* DASHBOARD VIEW */}
                            {view === 'dashboard' && (
                                <div className="fade-in space-y-6">
                                    <Card className="p-6 bg-white">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Seleccionar Docente:</label>
                                        <div className="relative">
                                            <select className="w-full p-3 border rounded-lg appearance-none bg-white font-medium" value={selectedTeacherId} onChange={(e) => selectTeacher(e.target.value)}>
                                                <option value="">-- Elige un docente --</option>
                                                {docentes.map(d => <option key={d.id} value={d.id}>{d.nombre}</option>)}
                                            </select>
                                            <div className="absolute right-4 top-4 text-slate-400 w-5 h-5 pointer-events-none"><Icons.ChevronDown/></div>
                                        </div>
                                        
                                        {activeDocente && !roleSelectionNeeded && (
                                            <div className="mt-4 p-4 bg-slate-100 rounded-lg border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">{activeDocente.nombre.charAt(0)}</div>
                                                    <div>
                                                        <div className="font-bold text-lg text-slate-800">{activeDocente.nombre}</div>
                                                        <div className="text-sm text-slate-500">{activeDocente.detalle}</div>
                                                    </div>
                                                </div>
                                                {activeRoles.length > 1 && (
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xs font-bold text-slate-500 uppercase flex items-center"><span className="w-4 h-4 mr-1"><Icons.Filter/></span> Ver como:</span>
                                                        <select className="p-2 text-sm border rounded bg-white" value={currentRoleFilter} onChange={(e) => setCurrentRoleFilter(e.target.value)}>
                                                            <option value="ALL">Vista General (Todo)</option>
                                                            {activeRoles.map(r => <option key={r} value={r}>Solo {r}</option>)}
                                                        </select>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </Card>

                                    {!activeDocente ? (
                                        <div className="text-center py-20 border-2 border-dashed rounded-xl flex flex-col items-center"><div className="w-16 h-16 text-slate-300 mb-4"><Icons.Users/></div><h3 className="text-xl text-slate-500 font-bold">Selecciona un docente para evaluar</h3></div>
                                    ) : roleSelectionNeeded ? (
                                        <div className="fade-in">
                                            <h3 className="text-center text-xl font-bold text-slate-700 mb-6">Este docente tiene múltiples roles. ¿Qué deseas ver?</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                                                <button onClick={() => { setCurrentRoleFilter("ALL"); setRoleSelectionNeeded(false); }} className="p-8 bg-white border-2 border-blue-100 hover:border-blue-500 rounded-xl shadow hover:shadow-lg transition text-center group flex flex-col items-center">
                                                    <div className="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4 group-hover:bg-blue-600 group-hover:text-white transition"><div className="w-8 h-8"><Icons.Chart/></div></div>
                                                    <h4 className="font-bold text-lg text-slate-800">Vista Completa</h4>
                                                    <p className="text-sm text-slate-500">Ver todo el progreso global</p>
                                                </button>
                                                {activeRoles.map(r => (
                                                    <button key={r} onClick={() => { setCurrentRoleFilter(r); setRoleSelectionNeeded(false); }} className="p-8 bg-white border-2 border-slate-100 hover:border-indigo-500 rounded-xl shadow hover:shadow-lg transition text-center group flex flex-col items-center">
                                                        <div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4 group-hover:bg-indigo-600 group-hover:text-white transition"><div className="w-8 h-8"><Icons.FileText/></div></div>
                                                        <h4 className="font-bold text-lg text-slate-800">{r}</h4>
                                                        <p className="text-sm text-slate-500">Evaluar solo este rol</p>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        <>
                                            {/* TABS INTERNOS */}
                                            <div className="flex p-1 bg-white border rounded-lg w-full md:w-fit mx-auto shadow-sm">
                                                <button onClick={() => setTeacherViewMode('stats')} className={`flex-1 px-6 py-2 rounded font-bold text-sm transition flex items-center justify-center ${teacherViewMode === 'stats' ? 'bg-blue-600 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}`}><span className="w-4 h-4 mr-2"><Icons.Chart/></span> Gráficos</button>
                                                <button onClick={() => setTeacherViewMode('check')} className={`flex-1 px-6 py-2 rounded font-bold text-sm transition flex items-center justify-center ${teacherViewMode === 'check' ? 'bg-blue-600 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}`}><span className="w-4 h-4 mr-2"><Icons.List/></span> Checklist</button>
                                            </div>

                                            {teacherViewMode === 'stats' ? (
                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
                                                    <div className="md:col-span-1">
                                                        <ChartSection title="AVANCE ACTUAL" percent={progress} color={progress < 50 ? '#ef4444' : '#10b981'} />
                                                    </div>
                                                    <Card className="md:col-span-2 p-6 border-t-4 border-t-indigo-500">
                                                        <h3 className="font-bold text-slate-700 mb-4">Estado de Documentación</h3>
                                                        <StatusGrid items={getRequiredDocs(activeDocente, currentRoleFilter)} docente={activeDocente} requiredItems={getRequiredDocs(activeDocente, currentRoleFilter)} />
                                                    </Card>
                                                </div>
                                            ) : (
                                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
                                                    <div className="lg:col-span-2">
                                                        <Card className="p-6 border-t-4 border-t-blue-500">
                                                            <ChecklistGroup title="LISTA DE COTEJO" items={DOCS} docente={activeDocente} requiredItems={getRequiredDocs(activeDocente, currentRoleFilter)} onToggle={toggleDoc} onObs={updateObs} onPercent={updatePercent} />
                                                        </Card>
                                                    </div>
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            )}

                            {/* LISTA VIEW */}
                            {view === 'list' && (
                                <div className="fade-in space-y-8">
                                    <Card className="p-8">
                                        <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center"><span className="w-6 h-6 mr-2 text-blue-600"><Icons.Plus/></span> Registrar Docente</h3>
                                        <form onSubmit={addTeacher} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="md:col-span-2">
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre Completo</label>
                                                <input required type="text" className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={newTeacher.nombre} onChange={e => setNewTeacher({...newTeacher, nombre: e.target.value})} placeholder="Ej. Juan Pérez" />
                                            </div>
                                            
                                            <div className="md:col-span-2 space-y-4">
                                                <label className="block text-xs font-bold text-slate-500 uppercase">Roles y Asignación (Seleccione y complete)</label>
                                                
                                                {/* TUTOR */}
                                                <div className={`p-4 border rounded-lg transition ${newTeacher.roles.includes(ROLES.TUTOR) ? 'bg-blue-50 border-blue-300' : 'bg-white'}`}>
                                                    <label className="flex items-center font-bold text-slate-700 cursor-pointer mb-2">
                                                        <input type="checkbox" className="w-5 h-5 mr-3" checked={newTeacher.roles.includes(ROLES.TUTOR)} onChange={() => toggleNewRole(ROLES.TUTOR)} />
                                                        {ROLES.TUTOR}
                                                    </label>
                                                    {newTeacher.roles.includes(ROLES.TUTOR) && (
                                                        <select className="w-full p-2 text-sm border rounded bg-white mt-2 animate-fade-in" value={newTeacher.details.grade} onChange={e => setNewTeacher({...newTeacher, details: {...newTeacher.details, grade: e.target.value}})}>
                                                            <option value="">-- Seleccionar Grado --</option>
                                                            {GRADES.map(g => <option key={g} value={g}>{g}</option>)}
                                                        </select>
                                                    )}
                                                </div>

                                                {/* AREA */}
                                                <div className={`p-4 border rounded-lg transition ${newTeacher.roles.includes(ROLES.AREA) ? 'bg-blue-50 border-blue-300' : 'bg-white'}`}>
                                                    <label className="flex items-center font-bold text-slate-700 cursor-pointer mb-2">
                                                        <input type="checkbox" className="w-5 h-5 mr-3" checked={newTeacher.roles.includes(ROLES.AREA)} onChange={() => toggleNewRole(ROLES.AREA)} />
                                                        {ROLES.AREA}
                                                    </label>
                                                    {newTeacher.roles.includes(ROLES.AREA) && (
                                                        <select className="w-full p-2 text-sm border rounded bg-white mt-2 animate-fade-in" value={newTeacher.details.area} onChange={e => setNewTeacher({...newTeacher, details: {...newTeacher.details, area: e.target.value}})}>
                                                            <option value="">-- Seleccionar Área --</option>
                                                            {AREAS.map(a => <option key={a} value={a}>{a}</option>)}
                                                        </select>
                                                    )}
                                                </div>

                                                {/* REGENCIA */}
                                                <div className={`p-4 border rounded-lg transition ${newTeacher.roles.includes(ROLES.REGENCIA) ? 'bg-blue-50 border-blue-300' : 'bg-white'}`}>
                                                    <label className="flex items-center font-bold text-slate-700 cursor-pointer mb-2">
                                                        <input type="checkbox" className="w-5 h-5 mr-3" checked={newTeacher.roles.includes(ROLES.REGENCIA)} onChange={() => toggleNewRole(ROLES.REGENCIA)} />
                                                        {ROLES.REGENCIA}
                                                    </label>
                                                    {newTeacher.roles.includes(ROLES.REGENCIA) && (
                                                        <input type="text" className="w-full p-2 text-sm border rounded mt-2 animate-fade-in" placeholder="Detalle Regencia" value={newTeacher.details.regency} onChange={e => setNewTeacher({...newTeacher, details: {...newTeacher.details, regency: e.target.value}})} />
                                                    )}
                                                </div>
                                            </div>

                                            <div className="md:col-span-2">
                                                <button className="w-full bg-blue-600 text-white font-bold p-3 rounded-lg hover:bg-blue-700 shadow-lg transition">Guardar Docente</button>
                                            </div>
                                        </form>
                                    </Card>

                                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                        <div className="p-4 bg-slate-50 border-b font-bold text-slate-600">Directorio ({docentes.length})</div>
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs">
                                                <tr><th className="p-4">Docente</th><th className="p-4">Roles</th><th className="p-4">Detalle</th><th className="p-4 text-right">Acción</th></tr>
                                            </thead>
                                            <tbody className="divide-y">
                                                {docentes.map(d => (
                                                    <tr key={d.id} className="hover:bg-blue-50 transition">
                                                        <td className="p-4 font-bold">{d.nombre}</td>
                                                        <td className="p-4">{getRoles(d).map(r=><span key={r} className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1">{r}</span>)}</td>
                                                        <td className="p-4 text-slate-600">{d.detalle}</td>
                                                        <td className="p-4 text-right"><button onClick={() => deleteTeacher(d.id)} className="text-red-400 hover:text-red-600"><div className="w-4 h-4"><Icons.Trash/></div></button></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>